- tags: always
  include_vars: mongo-vars.yml

- name: Display connection string
  block:
    - name: Which database?
      pause:
        prompt: "Which Mongo database? {{ mongodb_db_inventory | list }}"
        echo: yes
      register: __mongo_db
    - name: "Use the connection string below to connect to {{ __mongo_db.user_input }}"
      debug:
        msg:
        - "mongosh mongodb://{{ mongodb_db_inventory[__mongo_db.user_input].user }}:{{ mongodb_db_inventory[__mongo_db.user_input].password }}@{{ inventory_hostname }}:{{ mongodb_port }}/{{ __mongo_db.user_input }}"

    - name: Get DB version
      command:
          cmd: "mongosh mongodb://{{ mongodb_db_inventory[__mongo_db.user_input].user }}:{{ mongodb_db_inventory[__mongo_db.user_input].password }}@{{ inventory_hostname }}:{{ mongodb_port }}/{{ __mongo_db.user_input }} --eval \"db.version();\""
      register: __db_version
    - debug:
        var: __db_version.stdout
  delegate_to: localhost
  run_once: true
  tags:
    - tools.connect

- name: Display some restic commands
  debug:
    msg:
    - "AWS_ACCESS_KEY_ID={{ mongodb_s3.aws_access_key_id }} \
       AWS_SECRET_ACCESS_KEY={{ mongodb_s3.aws_secret_access_key }} \
       RESTIC_PASSWORD={{ mongodb_s3.restic_password }} \
       restic \
              -r s3:https://s3.epfl.ch/{{ mongodb_s3_bucket_path }} \
              ls -l latest {{ mongodb_backup_path }}"
  delegate_to: localhost
  run_once: true
  tags:
    - tools.restic
